<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Category: springboot - 브로오오그</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="브로오오그"><meta name="msapplication-TileImage" content="/img/catfavicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="브로오오그"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="브로오오그"><meta property="og:url" content="https://ogaree.github.io/"><meta property="og:site_name" content="브로오오그"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://ogaree.github.io/img/og_image.png"><meta property="article:author" content="OGAREE"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ogaree.github.io"},"headline":"브로오오그","image":["https://ogaree.github.io/img/og_image.png"],"author":{"@type":"Person","name":"OGAREE"},"description":""}</script><link rel="icon" href="/img/catfavicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/catlogo.jpg" alt="브로오오그" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/OGAREE"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">springboot</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-01-23T05:18:09.000Z" title="2021-1-23 5:18:09 AM">2021-01-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-25T05:44:37.423Z" title="2021-1-25 5:44:37 AM">2021-01-25</time></span><span class="level-item"><a class="link-muted" href="/categories/springboot/">springboot</a></span><span class="level-item">40 minutes read (About 5942 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/23/%EC%8A%A4%ED%94%84%EB%A7%81-%EC%8B%9C%ED%81%90%EB%A6%AC%ED%8B%B0%EC%99%80-OAuth2-0/">스프링_시큐리티와_OAuth2.0</a></h1><div class="content"><h4 id="스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다"><a href="#스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다" class="headerlink" title="* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *"></a><strong>* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *</strong></h4><hr>
<h1 id="목록"><a href="#목록" class="headerlink" title="목록"></a>목록</h1><ol>
<li>스프링 시큐리티와 스프링 시큐리티 OAuth2 클라이언트</li>
<li>구글 서비스 등록 및 구글 로그인 연동</li>
<li>어노테이션 기반으로 개선하기</li>
<li>세션 저장소로 데이터베이스 사용하기</li>
<li>네이버 로그인</li>
<li>기존 테스트에 시큐리티 적용하기</li>
</ol>
<hr>
<h2 id="스프링-시큐리티와-스프링-시큐리티-OAuth2-클라이언트"><a href="#스프링-시큐리티와-스프링-시큐리티-OAuth2-클라이언트" class="headerlink" title="스프링 시큐리티와 스프링 시큐리티 OAuth2 클라이언트"></a>스프링 시큐리티와 스프링 시큐리티 OAuth2 클라이언트</h2><p>스프링 시큐리티는 막강한 인증(Authentication)과 인가(Authorization)기능을 가진 프레임워크입니다. 사실상 스프링 기반의 애플리케이션에서는 보안을 위한 표준이라고 보면 됩니다. 인터셉터, 필터 기반의 보안 기능을 구현하는 것보다 스프링 시큐리티를 통해 구현하는 것을 적극적으로 권장하고 있습니다.</p>
<p>왜 많은 서비스에서 소셜 로그인을 사용할까요? 만약 로그인을 직접 구현한다하면 다음을 전부 구현해야 합니다.</p>
<ul>
<li>로그인 시 보안</li>
<li>비밀번호 찾기</li>
<li>비밀번호 변경</li>
<li>회원정보 변경</li>
<li>회원가입 시 이메일 혹은 전화번호 인증</li>
</ul>
<p>OAuth 로그인 구현 시 앞선 목록의 것들을 모두 구글, 페이스북, 네이버 등에 맡기면 되니 서비스 개발에 집중 할 수 있기 때문입니다.</p>
<h3 id="스프링-부트-1-5-VS-스프링-부트-2-0"><a href="#스프링-부트-1-5-VS-스프링-부트-2-0" class="headerlink" title="스프링 부트 1.5 VS 스프링 부트 2.0"></a>스프링 부트 1.5 VS 스프링 부트 2.0</h3><p>스프링 부트 1.5에서의 OAuth2 연동방법이 2.0에서는 크게 변경되었습니다. 하지만, 인터넷 자료들을 보면 <strong>설정 방법에 크게 차이가 없는 경우를 자주 봅니다</strong>. 이는 <strong>spring-security-oauth2-autoconfigure</strong>라이브러리 덕분입니다. 이를 사용할 경우 스프링 부트 2에서도 1.5에서 쓰던 설정을 그대로 사용할 수 있습니다.</p>
<p>스프링 부트 2에 관련한 인터넷 자료를 찾고 싶을 때 다음 2가지 를 확인하면 됩니다.</p>
<ol>
<li><strong>spring-security-oauth2-autoconfigure 라이브러리</strong>를 사용했는가?</li>
<li><strong>application.properties 혹은 application.yml 정보</strong>의 차이<ul>
<li>스프링 부트 1.5 방식에서는 url 주소를 모두 명시해야 하지만, 2.0 방식에서는 client 인정 정보만 입력 하면 됩니다.</li>
<li>1.5버전에서 직접 입력했던 값들은 2.0버전으로 오면서 모두 <strong>enum으로 대체 되었습니다</strong>.  <ul>
<li>CommonOAuth2Provider 라는 enum이 새롭게 추가되어 구글, 깃허브, 페이스북, 옥타(Okta)의 기본 설정값은 모두 여기서 제공합니다.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="구글-서비스-등록-및-구글-로그인-연동"><a href="#구글-서비스-등록-및-구글-로그인-연동" class="headerlink" title="구글 서비스 등록 및 구글 로그인 연동"></a>구글 서비스 등록 및 구글 로그인 연동</h2><hr>
<h2 id="구글-서비스-등록"><a href="#구글-서비스-등록" class="headerlink" title="구글 서비스 등록"></a>구글 서비스 등록</h2><p>먼저 구글 서비스에 신규 서비스를 생성합니다. 여기서 발급된 인증 정보(clientId와 clientSecret)를 통해서 로그인 기능과 소셜 서비스 기능을 사용할 수 있느니 무조건 발급받고 시작합니다.</p>
<ol>
<li>구글 클라우드 플랫폼으로 접속</li>
<li>상단에 프로젝트 선택 → 새 프로젝트</li>
<li>원하는 프로젝트 이름 지정</li>
<li>왼쪽 메뉴 탭 → API 및 서비스  </li>
<li>사용자 인증 정보 → 사용자 인증 정보 만들기 선택 → OAuth 클라이언트 ID → 동의 화면 구성</li>
<li>어플 이름 지정, 지원 이메일, Google Api 범위(email, profile, openid) → 저장</li>
<li>OAuth 클라이언트 ID 만들기 화면 → 어플리케이션 유형 → 웹 어플리케이션</li>
<li>승인된 리디렉션 URI → <a target="_blank" rel="noopener" href="http://localhost:8080/login/oauth2/code/google">http://localhost:8080/login/oauth2/code/google</a> 입력 후 생성<ul>
<li>서비스에서 파라미터로 인증 정보를 주었을 때 인증이 성공하면 구글에서 리다이렉트할 URL입니다.</li>
<li>스프링 부트 2 버전의 시큐리티에서는 기본적으로 {도메인}/login/oauth2/code/{소셜서비스코드}로 리다이렉트 URL을 지원하고 있습니다.</li>
<li>현재는 개발 단계이므로 <a target="_blank" rel="noopener" href="http://localhost:8080/login/oauth2/code/google%EB%A1%9C%EB%A7%8C">http://localhost:8080/login/oauth2/code/google로만</a> 등록합니다.</li>
<li>AWS 서버에 배포하게 되면 localhost 외에 추가로 주소를 추가해야하며, 이건 이후 단계에서 진행합니다.</li>
</ul>
</li>
</ol>
<ul>
<li>클라이언트 ID, 클라이언트 보안 비밀번호 생성 확인</li>
</ul>
<p>구글 서비스 등록이 끝났다면 src/main/resources/ 디렉토리에 application-oauth.properties 파일을 생성 합니다.<br>해당 파일에 클라이언트ID와 클라이언트 보안 비밀 코드를 다음과 같이 등록합니다. </p>
<h4 id="application-oauth-properties"><a href="#application-oauth-properties" class="headerlink" title="application-oauth.properties"></a>application-oauth.properties</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.security.oauth2.client.registration.google.client-id=클라이언트ID</span><br><span class="line">spring.security.oauth2.client.registration.google.client-secret=클라이언트 보안 비밀</span><br><span class="line">spring.security.oauth2.client.registration.google.scope=profile,email</span><br></pre></td></tr></table></figure>
<p><strong>scope=profile,email</strong></p>
<ul>
<li>많은 예제에서는 이 scope를 별도로 등록하지 않고 있습니다.</li>
<li>기본값이 openid, profile, email이기 때문입니다.</li>
<li>강제로 profile, email를 등록한 이유는 openid라는 scope가 있으면 Open Id Provider로 인식하기 때문입니다.</li>
<li>이렇게 되면 OpenId Provider인 서비스(구글)와 그렇지 않은 서비스(네이버/카카오 등)로 나눠서 각각 OAuth2Service를 만들어야 합니다.</li>
<li>하나의 OAuth2Service로 사용하기 위해 일부러 openid scope를 빼고 등록합니다.</li>
</ul>
<p>스프링 부트에서 properties의 이름을 application-xxx.properties로 xxx라는 이름의 profile이 생성되어 이를 통해 관리할 수 있습니다.<br>즉, profile=xxx라는 식으로 호출하면 <strong>해당 properties의 설정들을 가져올</strong> 수 있습니다.<br>application.properties에서 application-oauth.properties를 포함하도록 구성합니다.<br>application.properties에 다음 코드를 추가합니다.</p>
<h4 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.profiles.include=oauth</span><br></pre></td></tr></table></figure>
<p>clientID와 clientSecret은 외부에 노출될 경우 언제든 개인정보를 가져갈 수 있는 중요한 정보들입니다. 깃허브에 application-oauth.properties파일이 올라가는 것을 방지하기 위해 .gitignore에 코드를 추가해 줍니다.</p>
<h4 id="gitignore"><a href="#gitignore" class="headerlink" title="gitignore"></a>gitignore</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application-oauth.properties</span><br></pre></td></tr></table></figure>
<h2 id="구글-로그인-연동하기"><a href="#구글-로그인-연동하기" class="headerlink" title="구글 로그인 연동하기"></a>구글 로그인 연동하기</h2><p><strong>User 관련 Entity</strong></p>
<ul>
<li>1.User 클래스</li>
<li>2.Role Enum 클래스</li>
<li>3.UserRepository 클래스</li>
</ul>
<p><strong>스프링 시큐리티 설정</strong></p>
<ul>
<li>1.SecurityConfig 클래스</li>
<li>2.CustomOAuth2UserService 클래스</li>
<li>3.OAuthAttributes 클래스</li>
<li>4.SessionUser 클래스</li>
</ul>
<h3 id="User-관련-Entity"><a href="#User-관련-Entity" class="headerlink" title="User 관련 Entity"></a>User 관련 Entity</h3><hr>
<h3 id="1-User-클래스"><a href="#1-User-클래스" class="headerlink" title="1. User 클래스"></a>1. User 클래스</h3><p><strong>사용자 정보를 담당할 도메인입니다.</strong><br>domain패키지 아래에 user 패키지를 생성합니다.<br>user패키지에 User클래스를 생성합니다.  </p>
<h4 id="src-main-java-패키지명-domain-user-User"><a href="#src-main-java-패키지명-domain-user-User" class="headerlink" title="src/main/java/패키지명/domain/user/User"></a>src/main/java/패키지명/domain/user/User</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> 패키지명.domain.BaseTimeEntity;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseTimeEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String picture;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">    <span class="meta">@Column(nullable = false)</span></span><br><span class="line">    <span class="keyword">private</span> Role role;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, String email, String picture, Role role)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">        <span class="keyword">this</span>.picture = picture;</span><br><span class="line">        <span class="keyword">this</span>.role = role;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">update</span><span class="params">(String name, String picture)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.picture = picture;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.role.getKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**@Enumerated(EnumType.STRING) **</p>
<ul>
<li>JPA로 데이터베이스로 저장할 때 Enum 값을 어떤 형태로 저장할지를 결정합니다.</li>
<li>기본적으로는 int로 된 숫자가 저장됩니다.</li>
<li>숫자로 저장되면 데이터베이스로 확인할 때 그 값이 무슨 코드를 의미하는지 알 수가없습니다.</li>
<li>그래서 문자열(EnumType.STRING)로 저장될 수 있도록 선언합니다.</li>
</ul>
<h3 id="2-Role-Enum-클래스"><a href="#2-Role-Enum-클래스" class="headerlink" title="2. Role Enum 클래스"></a>2. Role Enum 클래스</h3><p><strong>각 사용자의 권한을 관리를 담당할 Enum클래스입니다.</strong><br>user패키지에 Role이라는 Enum클래스를 생성합니다.</p>
<h4 id="src-main-java-패키지명-domain-user-Role"><a href="#src-main-java-패키지명-domain-user-Role" class="headerlink" title="src/main/java/패키지명/domain/user/Role"></a>src/main/java/패키지명/domain/user/Role</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Role</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    GUEST(<span class="string">&quot;ROLE_GUEST&quot;</span>, <span class="string">&quot;손님&quot;</span>),</span><br><span class="line">    USER(<span class="string">&quot;ROLE_USER&quot;</span>, <span class="string">&quot;일반 사용자&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String title;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>스프링 시큐리티에서는 권한 코드에 항상 <strong>ROLE_ 이 앞에 있어야만</strong> 합니다.<br>그래서 코드별 키 값을 ROLE_GUEST, ROLE_USER 등으로 지정합니다.</p>
<h3 id="3-UserRepository-클래스"><a href="#3-UserRepository-클래스" class="headerlink" title="3. UserRepository 클래스"></a>3. UserRepository 클래스</h3><p><strong>User의 CRUD를 책임질 interface클래스입니다.</strong><br>user패키지에 UserRepository이라는 interface클래스를 생성합니다.</p>
<h4 id="src-main-java-패키지명-domain-user-UserRepository"><a href="#src-main-java-패키지명-domain-user-UserRepository" class="headerlink" title="src/main/java/패키지명/domain/user/UserRepository"></a>src/main/java/패키지명/domain/user/UserRepository</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.doop.book.springboot.domain.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Optional&lt;User&gt; <span class="title">findByEmail</span><span class="params">(String email)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>findByEmail</strong></p>
<ul>
<li>소셜 로그인으로 반환되는 값 중 email을 통해 이미 생성된 사용자인지 처음 가입하는 사용자인지 판단하기 위한 메소드입니다.</li>
</ul>
<h3 id="스프링-시큐리티-설정"><a href="#스프링-시큐리티-설정" class="headerlink" title="스프링 시큐리티 설정"></a>스프링 시큐리티 설정</h3><hr>
<p>build.gradle에 스프링 시큐리티 관련 의존성을 하나를 추가합니다.</p>
<h4 id="build-gradle"><a href="#build-gradle" class="headerlink" title="build.gradle"></a>build.gradle</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile(&#39;org.springframework.boot:spring-boot-starter-oauth2-client&#39;)</span><br></pre></td></tr></table></figure>
<p><strong>org.springframework.boot:spring-boot-starter-oauth2-client</strong></p>
<ul>
<li>소셜 로그인 등 클라이언트 입장에서 소셜 기능 구현 시 필요한 의존성입니다.</li>
<li>spring-boot-starter-oauth2-clientdhk spring-boot-starter-oauth2-jose를 기본으로 관리해줍니다.</li>
</ul>
<p>java디렉토리 아래에 Config.auth패키지를 생성합니다. 앞으로 <strong>시큐리티 관련 클래스는 모두 이곳에</strong> 담는다고 생각하시면 됩니다.</p>
<h3 id="1-SecurityConfig-클래스"><a href="#1-SecurityConfig-클래스" class="headerlink" title="1.SecurityConfig 클래스"></a>1.SecurityConfig 클래스</h3><p>OAuth라이브러리를 이용한 소셜 로그인 설정 코드를 작성합니다.</p>
<h4 id="src-main-java-패키지명-config-auth-SecurityConfig"><a href="#src-main-java-패키지명-config-auth-SecurityConfig" class="headerlink" title="src/main/java/패키지명/config/auth/SecurityConfig"></a>src/main/java/패키지명/config/auth/SecurityConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomOAuth2UserService customOAuth2UserService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.csrf().disable().headers().frameOptions().disable()</span><br><span class="line">                .and()</span><br><span class="line">                    .authorizeRequests()</span><br><span class="line">                    .antMatchers(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/images/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>,<span class="string">&quot;/h2-console/**&quot;</span>).permitAll()</span><br><span class="line">                    .antMatchers(<span class="string">&quot;/api/v1/**&quot;</span>).hasRole(Role.USER.name())</span><br><span class="line">                    .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                    .logout()</span><br><span class="line">                        .logoutSuccessUrl(<span class="string">&quot;/&quot;</span>) </span><br><span class="line">                .and()</span><br><span class="line">                    .oauth2Login()</span><br><span class="line">                        .userInfoEndpoint()</span><br><span class="line">                            .userService(customOAuth2UserService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@EnableWebSecurity</strong></p>
<ul>
<li>Spring Security 설정들을 활성화시켜 줍니다.</li>
</ul>
<p><strong>csrf().disable().headers().frameOptions().disable()</strong></p>
<ul>
<li>h2-console 화면을 사용하기 위해 해당 옵션들을 disable 합니다</li>
</ul>
<p><strong>authorizeRequests</strong></p>
<ul>
<li>URL별 권한 관리를 설정하는 옵션의 시작점입니다.</li>
<li>authorizeRequests가 선업되어야만 antMatchers 옵션을 사용할 수 있습니다.</li>
</ul>
<p><strong>antMatchers</strong></p>
<ul>
<li>권한 관리 대상을 지정하는 옵션입니다.</li>
<li>URL, HTTP 메소드별로 관리가 가능합니다.</li>
<li>”/” 등 지정된 URL 들은 permitAll() 옵션을 통해 전체 열람 권한을 주었습니다.</li>
<li>“/api/v1/**” 주소를 가진 API는 USER 권한을 가진 사람만 가능하도록 했습니다.</li>
</ul>
<p>** anyRequest**</p>
<ul>
<li>설정된 값들 이외 나머지 URL들을 나타냅니다.</li>
<li>여기서는 authenticated()을 추가하여 나머지 URL들은 모두 인증된 사용자들에게만 허용하게 합니다.</li>
<li>인증된 사용자 즉, 로그인한 사용자들을 이야기합니다.</li>
</ul>
<p><strong>gout().logoutSuccessUrl(“/“)</strong></p>
<ul>
<li>로그아웃 기능에 대한 여러 설정의 진입점입니다.</li>
<li>로그아웃 성공 시 / 주소로 이동합니다.</li>
</ul>
<p><strong>oauth2Login()</strong></p>
<ul>
<li>OAuth 2 로그인 기능에 대한 여러 설정의 진입점입니다.</li>
</ul>
<p><strong>userInfoEndpoint()</strong></p>
<ul>
<li>OAuth 2 로그인 성공 이후 사용자 정보를 가져올 때의 설정들을 담당합니다.</li>
</ul>
<p><strong>userService</strong></p>
<ul>
<li>소셜 로그인 성공 시 후속 조치를 진행할 UserService 인터페이스의 구현체를 등록합니다.</li>
<li>리소스 서버(즉, 소셜 서비스들)에서 사용자 정보를 가져온 상태에서 추가로 진행하고 자 하는 기능을 명시할 수 있습니다.</li>
</ul>
<h3 id="2-CustomOAuth2UserService클래스"><a href="#2-CustomOAuth2UserService클래스" class="headerlink" title="2.CustomOAuth2UserService클래스"></a>2.CustomOAuth2UserService클래스</h3><p>구글 로그인 이후 가져온 사용자의 정보(email, name, picture 등)들을 기반으로 가입 및 정보수정, 세션 저장 등의 기능을 지원합니다.</p>
<h4 id="src-main-java-패키지명-config-auth-CustomOAuth2UserService"><a href="#src-main-java-패키지명-config-auth-CustomOAuth2UserService" class="headerlink" title="src/main/java/패키지명/config/auth/CustomOAuth2UserService"></a>src/main/java/패키지명/config/auth/CustomOAuth2UserService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.userinfo.OAuth2UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.OAuth2AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.user.DefaultOAuth2User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.user.OAuth2User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomOAuth2UserService</span> <span class="keyword">implements</span> <span class="title">OAuth2UserService</span>&lt;<span class="title">OAuth2UserRequest</span>, <span class="title">OAuth2User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpSession httpSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2User <span class="title">loadUser</span><span class="params">(OAuth2UserRequest userRequest)</span> <span class="keyword">throws</span> OAuth2AuthenticationException </span>&#123;</span><br><span class="line">        OAuth2UserService&lt;OAuth2UserRequest, OAuth2User&gt;</span><br><span class="line">                delegate = <span class="keyword">new</span> DefaultOAuth2UserService();</span><br><span class="line">        OAuth2User oAuth2User = delegate.loadUser(userRequest);</span><br><span class="line"></span><br><span class="line">        String registractionId=userRequest.getClientRegistration().getProviderDetails()</span><br><span class="line">                .getUserInfoEndpoint().getUserNameAttributeName();</span><br><span class="line">        String userNameAttributeName=userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName();</span><br><span class="line"></span><br><span class="line">        OAuthAttributes attributes = OAuthAttributes.of(registractionId, userNameAttributeName, oAuth2User.getAttributes());</span><br><span class="line"></span><br><span class="line">        User user = saveOrUpdate(attributes);</span><br><span class="line">        httpSession.setAttribute(<span class="string">&quot;user&quot;</span>,<span class="keyword">new</span> SessionUser(user));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultOAuth2User(Collections.singleton(<span class="keyword">new</span> SimpleGrantedAuthority(user.getRolekey())),</span><br><span class="line">        attributes.getAttributes(),</span><br><span class="line">        attributes.getNameAttributekey());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> User <span class="title">saveOrUpdate</span><span class="params">(OAuthAttributes attributes)</span></span>&#123;</span><br><span class="line">        User user = userRepository.findByEmail(attributes.getEmail())</span><br><span class="line">                .map(entity -&gt; entity.update(attributes.getName(),attributes.getPicture()))</span><br><span class="line">                .orElse(attributes.toEntity());</span><br><span class="line">        <span class="keyword">return</span> userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>getRegistrationId</strong></p>
<ul>
<li>현재 로그인 진행 중인 서비스를 구분하는 코드입니다.</li>
<li>지금은 구글만 사용하는 불필요한 값이지만, 이후 네이버 로그인 연동 시에 네이버로 로그인인지, 구글 로그인인지 구분하기 위해 사용합니다.</li>
</ul>
<p><strong>getUserNameAttributeName</strong></p>
<ul>
<li>OAuth2 로그인 진행 시 키가 되는 필드값을 이야기합니다. Primary Key와 같은 의미입니다.</li>
<li>구글의 경우 기본적으로 코드를 지원하지만, 네이버 카카오 등은 기본 지원하지 않습니다. 구글의 기본 코드는 “sub” 입니다.</li>
<li>이후 네이버 로그인과 구글 로그인을 동시 지원할 때 사용됩니다.</li>
</ul>
<p><strong>OAuthAttributes</strong></p>
<ul>
<li>OAuth2userService를 통해 가져온 OAuth2User의 attribute를 담을 클래스입니다.</li>
<li>이후 네이버 등 다른 소셜 로그인도 이 클래스를 사용합니다.</li>
<li>바로 아래에서 이 클래스의 코드가 나오니 차례로 생성하시면 됩니다.</li>
</ul>
<p><strong>SessionUser</strong></p>
<ul>
<li>세션에 사용자 정보를 저장하기 위한 Dto 클래스입니다.</li>
<li>왜 User클래스를 쓰지 않고 새로 만들어서 쓰는지는 아래에서 설명하겠습니다.</li>
</ul>
<p><strong>saveOrUpdate</strong></p>
<ul>
<li>구글 사용자 정보가 업데이트 되었을 때를 대비하여 update 기능도 같이 구현하였습니다.</li>
<li>사용자의 이름이나 프로필 사진이 변경되면 User 엔티티에도 반영됩니다.</li>
</ul>
<blockquote>
<p><strong>왜 User클래스를 사용하면 안되는가?</strong></p>
<p>만약 User클래스를 그대로 사용했다면 에러가 발생합니다.<br>에러의 내용은 <strong>“User클래스에 직렬화를 구현하지 않았다”</strong> 입니다.<br>그럼 User클래스에 직렬화 코드를 넣으면 된다고 생각할 수 도 있습니다.<br>하지만 User클래스가 엔티티이기 때문에 <strong>넣지 않는게 좋습니다</strong>.<br>엔티티 클래스에는 언제 다른 엔티티와 관계가 형성될지 모릅니다.<br>예를 들어 @OneToMany, @ManyToMany 등 자식 엔티티를 갖고 있다면 직렬화 대상에 자식들까지 포함되니 성능 이슈, 부수 효과가 발생할 확률이 높습니다.<br>그래서 직렬화 기능을 가진 세션 Dto를 하나 추가로 만드는 것이 이후 운영 및 유지보수 때 많은 도움이 됩니다.</p>
</blockquote>
<h3 id="3-OAuthAttributes-클래스"><a href="#3-OAuthAttributes-클래스" class="headerlink" title="3.OAuthAttributes 클래스"></a>3.OAuthAttributes 클래스</h3><p>저자는 OAuthAttributes를 dto클래스로 간주합니다.<br>config.auth.dto 패키지를 만들어 그 안에 클래스 생성합니다</p>
<h4 id="src-main-java-패키지명-config-auth-dto-OAuthAttributes"><a href="#src-main-java-패키지명-config-auth-dto-OAuthAttributes" class="headerlink" title="src/main/java/패키지명/config/auth/dto/OAuthAttributes"></a>src/main/java/패키지명/config/auth/dto/OAuthAttributes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuthAttributes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attributes;</span><br><span class="line">    <span class="keyword">private</span> String nameAttributekey;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String picture;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OAuthAttributes</span><span class="params">(Map&lt;String, Object&gt; attributes,String nameAttributekey, String name, String email, String picture)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.attributes=attributes;</span><br><span class="line">        <span class="keyword">this</span>.nameAttributekey=nameAttributekey;</span><br><span class="line">        <span class="keyword">this</span>.name=name;</span><br><span class="line">        <span class="keyword">this</span>.email=email;</span><br><span class="line">        <span class="keyword">this</span>.picture=picture;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OAuthAttributes <span class="title">of</span><span class="params">(String registrationId, String userNameAttributeName, Map&lt;String, Object&gt; attributes)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ofGoogle(userNameAttributeName, attributes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> OAuthAttributes <span class="title">ofGoogle</span><span class="params">(String userNameAttributeName, Map&lt;String, Object&gt; attributes)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OAuthAttributes.builder()</span><br><span class="line">                .name((String) attributes.get(<span class="string">&quot;name&quot;</span>))</span><br><span class="line">                .email((String) attributes.get(<span class="string">&quot;email&quot;</span>))</span><br><span class="line">                .picture((String) attributes.get(<span class="string">&quot;picture&quot;</span>))</span><br><span class="line">                .attributes(attributes)</span><br><span class="line">                .nameAttributekey(userNameAttributeName)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">toEntity</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> User.builder()</span><br><span class="line">                .name(name)</span><br><span class="line">                .email(email)</span><br><span class="line">                .picture(picture)</span><br><span class="line">                .role(Role.GUEST)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>of()</strong></p>
<ul>
<li>OAuth2User에서 반환하는 사용자 정보는 Map이기 때문에 값 하나하나를 변환해야만 합니다.</li>
</ul>
<p><strong>toEntity()</strong></p>
<ul>
<li>User 엔티티를 생성합니다.</li>
<li>OAuthAttribute에서 엔티티를 생성하는 시점은 처음 가입할 때입니다.</li>
<li>가입할 때의 기본 권한을 GUEST로 주기 위해서 role 빌더값에는 Role.GUEST를 사용합니다.</li>
</ul>
<h3 id="4-SessionUser-클래스"><a href="#4-SessionUser-클래스" class="headerlink" title="4.SessionUser 클래스"></a>4.SessionUser 클래스</h3><p>인증된 사용자의 정보만 가져옵니다.<br>config.auth.dto패키지에 SessionUser클래스를 생성합니다.</p>
<h4 id="src-main-java-패키지명-config-auth-dto-SessionUser"><a href="#src-main-java-패키지명-config-auth-dto-SessionUser" class="headerlink" title="src/main/java/패키지명/config/auth/dto/SessionUser"></a>src/main/java/패키지명/config/auth/dto/SessionUser</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionUser</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String picture;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = user.getName();</span><br><span class="line">        <span class="keyword">this</span>.email = user.getEmail();</span><br><span class="line">        <span class="keyword">this</span>.picture = user.getPicture();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>모든 시큐리티 설정이 끝났습니다. 그럼 로그인 기능을 한번 테스트 해보겠습니다.</p>
<h3 id="로그인-테스트"><a href="#로그인-테스트" class="headerlink" title="로그인 테스트"></a>로그인 테스트</h3><p>스프링 시큐리티가 잘 적용되었는지 확인하기 위해 화면에 로그인 버튼을 추가해 보겠습니다.</p>
<p>index.mustache에 로그인 버튼과 로그인 성공 시 사용자 이름을 보여주는 코드입니다.</p>
<h4 id="index-mustache"><a href="#index-mustache" class="headerlink" title="index.mustache"></a>index.mustache</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>스프링 부트로 시작하는 웹 서비스<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-12&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">calss</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-6&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/posts/save&quot;</span> <span class="attr">role</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>글 등록<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;&#123;#userName&#125;&#125;</span><br><span class="line">                    Logged in as: <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-info active&quot;</span> <span class="attr">role</span>=<span class="string">&quot;button&quot;</span>&gt;</span>Logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;&#123;/userName&#125;&#125;</span><br><span class="line"></span><br><span class="line">                &#123;&#123;^userName&#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/oauth2/authorization/google&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-success active&quot;</span> <span class="attr">role</span>=<span class="string">&quot;button&quot;</span>&gt;</span>Google Login<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;&#123;/userName&#125;&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--목록 출력 영역--&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>&#123;&#123;#userName&#125;&#125;</strong></p>
<ul>
<li>머스테치는 다른 언어와 같은 if문(if userName != null)을 제공하지 않습니다.</li>
<li>true/false 여부만 판단할 뿐입니다.</li>
<li>그래서 머스테치에서는 항상 최종값을 넘겨줘야 합니다.</li>
<li>여기서도 역시 userName이 있다면 userName을 노출시키도록 구성했습니다.</li>
</ul>
<p><strong>a href=”/logout”</strong></p>
<ul>
<li>스프링 시큐리티에서 기본적으로 제공하는 로그아웃 URL 입니다.</li>
<li>즉, 개발자가 별도로 저 URL에 해당하는 컨트롤러를 만들 필요가 없습니다.</li>
<li>SecurityConfig 클래스에서 URL을 변경할 순 있지만 기본 URL을 사용해도 충분하니 여기서는 그래도 사용합니다.</li>
</ul>
<p><strong>&#123;&#123;^userName&#125;&#125;</strong></p>
<ul>
<li>머스테치에서 해당 값이 존재하지 않는 경우에는 ^를 사용합니다.</li>
<li>여기서는 userName이 없다면 로그인 버튼을 노출시키도록 구성했습니다.</li>
</ul>
<p><strong>a href=”/oauth2/authorization/google”</strong></p>
<ul>
<li>스프링 시큐리티에서 기본적으로 제공하는 로그인 URL입니다.</li>
<li>로그아웃 URL과 마찬가지로 개발자가 별도의 컨트롤러를 생성할 필요가 없습니다.</li>
</ul>
<p>index.mustache에서 userName을 사용할 수 있게 IndexController에서 userName을 model에 저장하는 코드를 추가해줍니다.</p>
<h4 id="IndexController"><a href="#IndexController" class="headerlink" title="IndexController"></a>IndexController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">indexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostsService postsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpSession httpSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(Model model)</span></span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;posts&quot;</span>,postsService.findAllDesc());</span><br><span class="line"></span><br><span class="line">		SessionUser user = (SessionUser) httpSession.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;userName&quot;</span>, user.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	... 중략</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>(SessionUser) httpSession.getAttribute(“user”);</strong></p>
<ul>
<li>앞서 작성된 CustomOAuth2UserService에서 로그인 성공 시 세션에 SessionUser를 저장하도록 구성했습니다.</li>
<li>즉, 로그인 성공 시 httpSession.getAttribute(“user”)에서 값을 가져올 수 있습니다.</li>
</ul>
<p><strong>if(user != null)</strong></p>
<ul>
<li>세션에 저장된 값이 있을 때만 model에 userName으로 등록합니다.</li>
<li>세션에 저장된 값이 없으면 model엔 아무런 값이 없는 상태이니 로그인 버튼이 보이게 됩니다.</li>
</ul>
<p>로그인은 정상적으로 동작하는 것을 볼 수 있습니다.<br>h2-console에서 user테이블에 회원정보가 들어간 것 까지 확인할 수 있습니다.<br>하지만 게시글 등록은 403에러(권한 거부)를 띄우게 됩니다.<br>이는 현재 로그인된 사용자의 권한이 GUEST이기 때문입니다.<br>h2-console에서 사용자의 role을 User로 변경합니다.  </p>
<p><img src="" alt="권한 변경"><br>세션에는 GUEST의 정보로 저장되었으니 로그아웃후 다시 로그인 하면 게시글 등록 또한 정상적으로 동작 함을 볼 수 있습니다.</p>
<h2 id="어노테이션-기반으로-개선하기"><a href="#어노테이션-기반으로-개선하기" class="headerlink" title="어노테이션 기반으로 개선하기"></a>어노테이션 기반으로 개선하기</h2><p>프로그래밍에서 개선이 필요한 나쁜 코드는 <strong>같은 코드가 반복 되는 부분</strong>입니다. 같은 코드가 반복되는 부분이 많아지면 이후 수정이 필요할 때 모든 부분을 하나씩 찾아가며 수정해야만 합니다. 이렇게 될 경우 유지보수성이 떨어질 수 밖에 없으며, 혹시나 수정이 반영되지 않은 반복 코드가 있다면 문제가 발생할 수밖에 없습니다.</p>
<p>앞서 만든 것들 중 IndexController에서 세션값을 가져오는 부분이 반복되는 코드입니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SessionUser user &#x3D; (SessionUser) httpSession.getAttribute(&quot;user&quot;);</span><br></pre></td></tr></table></figure>
<p>index메소드 외에 다른 컨트롤러와 메소드에서 세션값이 필요하면 그때마다 직접 세션에서 값을 가져와야 합니다.<br>그래서 이 부분을 메소드 인자로 세션값을 바로 받을 수 있도록 변경해 보겠습니다.</p>
<p>config.auth 패키지에 @LoginUser 어노테이션을 생성합니다.</p>
<h4 id="src-main-java-패키지명-config-auth-LoginUser"><a href="#src-main-java-패키지명-config-auth-LoginUser" class="headerlink" title="src/main/java/패키지명/config/auth/LoginUser"></a>src/main/java/패키지명/config/auth/LoginUser</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.PARAMETER)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LoginUser &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@Target(ElementType.PARAMETER)</strong></p>
<ul>
<li>이 어노테이션이 생성될 수 있는 위치를 지정합니다.</li>
<li>PARAMETER로 지정했으니 메소드의 파라미터로 선언된 개겣에서만 사용할 수 있습니다.</li>
<li>이 외에도 클래스 선언문에 쓸 수 있는 TYPE 등이 있습니다.</li>
</ul>
<p><strong>@interface</strong></p>
<ul>
<li>이 파일을 어노테이션 클래스로 지정합니다.</li>
<li>LoginUser라는 이름을 가진 어노테이션이 생성되었다고 보면 됩니다.</li>
</ul>
<p>그리고 같은 위치에 LoginUserArgumentResolver를 생성 합니다.<br>이 클래스는 HandlerMethodArgumentResolver 인터페이스를 구현한 클래스입니다.</p>
<p>HandlerMethodArgumentResolver는 한가지 기능을 지원합니다.<br>바로 조건에 맞는 경우 메소드가 있다면 HandlerMethodArgumentResolver의 구현체가 지정한 값으로 해당 메소드의 파라미터로 넘길 수 있습니다.</p>
<h4 id="LoginUserArgumentResolver"><a href="#LoginUserArgumentResolver" class="headerlink" title="LoginUserArgumentResolver"></a>LoginUserArgumentResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.support.WebDataBinderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.NativeWebRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.ModelAndViewContainer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginUserArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpSession httpSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isLoginUserAnnotation = parameter.getParameterAnnotation(LoginUser.class) != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isUserClass = SessionUser.class.equals(parameter.getParameterType());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> isLoginUserAnnotation &amp;&amp; isUserClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  NativeWebRequest webRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> httpSession.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>supportsParameter()</strong></p>
<ul>
<li>컨트롤러 메서드의 특정 파라미터를 지원하는지 판단합니다.  </li>
<li>여기서는 파라미터에 @LoginUser 어노테이션이 붙어 있고, 파라미터 클래스 타입이 Sessionuser.class인 경우 -true를 반환합니다.  </li>
</ul>
<p><strong>resolveArgument()</strong></p>
<ul>
<li>파라미터에 전달할 객체를 생성합니다.</li>
<li>여기서는 세션에서 객체를 가져옵니다.</li>
</ul>
<p>생성된 LoginUserArgumentResolver가 <strong>스프링에서 인식될 수 있도록</strong> WebMvcConfigurer에 추가하겠습니다.<br>config패키지에 WebConfig클래스를 생성하여 다음과 같이 설정을 추가합니다.</p>
<h4 id="src-main-java-패키지명-config-WebConfig"><a href="#src-main-java-패키지명-config-WebConfig" class="headerlink" title="src/main/java/패키지명/config/WebConfig"></a>src/main/java/패키지명/config/WebConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoginUserArgumentResolver loginUserArgumentResolver;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers)</span> </span>&#123;</span><br><span class="line">        argumentResolvers.add(loginUserArgumentResolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HandlerMethodArgumentResolver는 항상 WebMvcConfigurer의 addArgumentResolvers()를 통해 추가해야 합니다.<br>다른 Handler-MethodArgumentResolver가 필요 한다면 같은 방식으로 추가해 주면 됩니다.</p>
<p>마지막으로 IndexController의 코드에서 반복되는 부분들을 모두 @LoginUser로 바꾸어 줍니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">indexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostsService postsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpSession httpSession;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(Model model, <span class="meta">@LoginUser</span> SessionUser user)</span></span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;posts&quot;</span>,postsService.findAllDesc());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;userName&quot;</span>, user.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	... 중략</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@LoginUser SessionUser user</strong></p>
<ul>
<li>기존에 (User) httpSession.getAttribute(“user”) 로 가져오던 세션 정보 값이 개선 되었습니다.</li>
<li>이제는 어느 컨트롤러든지 @Loginuser만 사용하면 세션 정보를 가져올 수 있게 되었습니다.</li>
</ul>
<p>다시 어플리케이샨을 실행해 로그인 기능이 정상적으로 작동하는 것을 확인합니다.</p>
<h2 id="세션-저장소로-데이터베이스-사용하기"><a href="#세션-저장소로-데이터베이스-사용하기" class="headerlink" title="세션 저장소로 데이터베이스 사용하기"></a>세션 저장소로 데이터베이스 사용하기</h2></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-01-12T13:41:46.000Z" title="2021-1-12 1:41:46 PM">2021-01-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-18T03:06:46.495Z" title="2021-1-18 3:06:46 AM">2021-01-18</time></span><span class="level-item"><a class="link-muted" href="/categories/springboot/">springboot</a></span><span class="level-item">37 minutes read (About 5608 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/12/%EB%A8%B8%EC%8A%A4%ED%85%8C%EC%B9%98%EB%A1%9C-%ED%99%94%EB%A9%B4-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0/">머스테치로_화면_구성하기</a></h1><div class="content"><h4 id="스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다"><a href="#스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다" class="headerlink" title="* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *"></a><strong>* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *</strong></h4><hr>
<h1 id="목록"><a href="#목록" class="headerlink" title="목록"></a>목록</h1><ol>
<li>서버 템플릿 엔진과 머스테치 소개</li>
<li>게시글 등록 화면 만들기</li>
<li>게시글 조회 화면 만들기</li>
<li>게시글 수정, 삭제 화면 만들기</li>
</ol></div><a class="article-more button is-small is-size-7" href="/2021/01/12/%EB%A8%B8%EC%8A%A4%ED%85%8C%EC%B9%98%EB%A1%9C-%ED%99%94%EB%A9%B4-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-01-10T04:49:21.000Z" title="2021-1-10 4:49:21 AM">2021-01-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-23T05:26:53.187Z" title="2021-1-23 5:26:53 AM">2021-01-23</time></span><span class="level-item"><a class="link-muted" href="/categories/springboot/">springboot</a></span><span class="level-item">an hour read (About 7449 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/10/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8%EC%97%90%EC%84%9CJPA%EB%A1%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EB%8B%A4%EB%A3%A8%EA%B8%B0/">스프링부트에서 JPA로 데이터베이스 다루기</a></h1><div class="content"><h4 id="스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다"><a href="#스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다" class="headerlink" title="* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *"></a><strong>* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *</strong></h4><hr>
<h1 id="목록"><a href="#목록" class="headerlink" title="목록"></a>목록</h1><ol>
<li>JPA소개</li>
<li>프로젝트에 Spring Data Jpa 적용하기</li>
<li>Spring Data JPA 테스트 코드 작성하기</li>
<li>등록/수정/조회 API 만들기</li>
<li>JPA Audtiting을 이용한 등록/수정 시간 자동화</li>
</ol></div><a class="article-more button is-small is-size-7" href="/2021/01/10/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8%EC%97%90%EC%84%9CJPA%EB%A1%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EB%8B%A4%EB%A3%A8%EA%B8%B0/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-01-09T04:35:00.000Z" title="2021-1-9 4:35:00 AM">2021-01-09</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-23T05:26:54.167Z" title="2021-1-23 5:26:54 AM">2021-01-23</time></span><span class="level-item"><a class="link-muted" href="/categories/springboot/">springboot</a></span><span class="level-item">20 minutes read (About 3074 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/09/%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0/">테스트코드_작성하기</a></h1><div class="content"><h4 id="스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다"><a href="#스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다" class="headerlink" title="* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *"></a><strong>* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *</strong></h4><hr>
<h1 id="목록"><a href="#목록" class="headerlink" title="목록"></a>목록</h1><ol>
<li>TDD와 단위 테스트<ul>
<li>TDD</li>
<li>단위 테스트</li>
<li>테스트 코드를 작성하는 이유</li>
</ul>
</li>
<li>테스트 코드 작성하기<ul>
<li>main 클래스 작성하기</li>
<li>내장 WAS를 사용을 권장하는 이유</li>
<li>test 코드 작성하기</li>
</ul>
</li>
<li>자바 롬복(Lombok) <ul>
<li>설치</li>
<li>Hello Controller 코드 롬복으로 전환하기</li>
<li>assertj의 장점</div><a class="article-more button is-small is-size-7" href="/2021/01/09/%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-01-06T08:34:56.000Z" title="2021-1-6 8:34:56 AM">2021-01-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-23T05:26:51.663Z" title="2021-1-23 5:26:51 AM">2021-01-23</time></span><span class="level-item"><a class="link-muted" href="/categories/springboot/">springboot</a></span><span class="level-item">7 minutes read (About 999 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/06/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/">스프링부트_시작하기</a></h1><div class="content"><h4 id="스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다"><a href="#스프링-부트와-AWS로-혼자-구현하는-웹-서비스-프리렉-이동욱-지음-책을-통해-공부한-내용을-정리한-글입니다" class="headerlink" title="* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *"></a><strong>* 스프링 부트와 AWS로 혼자 구현하는 웹 서비스(프리렉, 이동욱 지음)책을 통해 공부한 내용을 정리한 글입니다. *</strong></h4><hr>
<h1 id="목록"><a href="#목록" class="headerlink" title="목록"></a>목록</h1><ol>
<li>그레이들 프로젝트 변경</li>
<li>코드 설명</li>
</ol></div><a class="article-more button is-small is-size-7" href="/2021/01/06/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/#more">Read more</a></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="오가리"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">오가리</p><p class="is-size-6 is-block">학생</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>지구</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">8</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/OGAREE" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/OGAREE"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/springboot/"><span class="level-start"><span class="level-item">springboot</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/test/"><span class="level-start"><span class="level-item">test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-23T05:18:09.000Z">2021-01-23</time></p><p class="title"><a href="/2021/01/23/%EC%8A%A4%ED%94%84%EB%A7%81-%EC%8B%9C%ED%81%90%EB%A6%AC%ED%8B%B0%EC%99%80-OAuth2-0/">스프링_시큐리티와_OAuth2.0</a></p><p class="categories"><a href="/categories/springboot/">springboot</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-12T13:41:46.000Z">2021-01-12</time></p><p class="title"><a href="/2021/01/12/%EB%A8%B8%EC%8A%A4%ED%85%8C%EC%B9%98%EB%A1%9C-%ED%99%94%EB%A9%B4-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0/">머스테치로_화면_구성하기</a></p><p class="categories"><a href="/categories/springboot/">springboot</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-10T04:49:21.000Z">2021-01-10</time></p><p class="title"><a href="/2021/01/10/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8%EC%97%90%EC%84%9CJPA%EB%A1%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EB%8B%A4%EB%A3%A8%EA%B8%B0/">스프링부트에서 JPA로 데이터베이스 다루기</a></p><p class="categories"><a href="/categories/springboot/">springboot</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-09T04:35:00.000Z">2021-01-09</time></p><p class="title"><a href="/2021/01/09/%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0/">테스트코드_작성하기</a></p><p class="categories"><a href="/categories/springboot/">springboot</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-06T08:34:56.000Z">2021-01-06</time></p><p class="title"><a href="/2021/01/06/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/">스프링부트_시작하기</a></p><p class="categories"><a href="/categories/springboot/">springboot</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/JPA/"><span class="tag">JPA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OAuth-2-0/"><span class="tag">OAuth 2.0</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%EA%B9%83%ED%97%88%EB%B8%8C-%EB%B8%94%EB%A1%9C%EA%B7%B8/"><span class="tag">깃허브 블로그</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%EB%A8%B8%EC%8A%A4%ED%85%8C%EC%B9%98/"><span class="tag">머스테치</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B6%80%ED%8A%B8%EC%99%80-AWS%EB%A1%9C-%ED%98%BC%EC%9E%90-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-%EC%9B%B9-%EC%84%9C%EB%B9%84%EC%8A%A4/"><span class="tag">스프링 부트와 AWS로 혼자 구현하는 웹 서비스</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%EC%8A%A4%ED%94%84%EB%A7%81-%EC%8B%9C%ED%81%90%EB%A6%AC%ED%8B%B0/"><span class="tag">스프링 시큐리티</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%BD%94%EB%93%9C/"><span class="tag">테스트 코드</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/catlogo.jpg" alt="브로오오그" height="28"></a><p class="is-size-7"><span>&copy; 2021 OGAREE</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/OGAREE"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>